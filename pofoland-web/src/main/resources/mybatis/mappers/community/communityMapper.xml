<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.hst.pofoland.biz.community.dao.CommunityDAO">
    
    <!-- Community 게시글 목록 조회 -->
    <select id="findList" resultType="Community">
   		SELECT
        	 T1.BOARD_NO		AS	boardNo		/* 게시글번호 */
        	,T1.BOARD_SE_CD		AS	boardSeCd 	/* 게시글구분코드 */
        	,T1.BOARD_TTL		AS	boardTtl	/* 게시글제목 */
        	,T1.BOARD_CONT		AS	boardCont	/* 게시글내용 */
        	,T1.REG_DTM			AS	regDtm		/* 등록일시 */
        	,T1.REG_USER_NO		AS	regUserNo	/* 등록사용자번호 */
            ,T2.USER_EMAIL		AS	regUserId	/* 등록사용자ID */
        	,T1.UPD_DTM			AS	updDtm		/* 수정일시 */
        	,T1.UPD_USER_NO		AS	updUserNo	/* 수정사용자번호 */
        	,T1.BOARD_RFNC_CNT	AS	boardRfncCnt/* 조회수 */
        	,T1.DEL_YN			AS	delYn		/* 삭제여부 */
         FROM
         	CM_BOARD 	T1			/* 게시판T */
			INNER JOIN MB_USER T2	/* 사용자T */
            ON T1.REG_USER_NO = T2.USER_NO
         <where>
         	<if test='boardSeCd != null and boardSeCd != ""'>
         	AND BOARD_SE_CD = #{boardSeCd}	/* 게시글구분코드 */
         	</if>
         	AND T1.DEL_YN = 'N'	/* 삭제여부 N */
         </where> 
    </select>
    
    <!-- Community 게시글 상세 조회 -->
    <select id="findOne" parameterType="Community" resultType="Community">
    	SELECT
    		 T1.BOARD_NO		AS	boardNo		/* 게시글번호 */
    		,T1.BOARD_SE_CD		AS	boardSeCd 	/* 게시글구분코드 */
        	,T1.BOARD_TTL		AS	boardTtl	/* 게시글제목 */
        	,T1.BOARD_CONT		AS	boardCont	/* 게시글내용 */
        	,T1.REG_DTM			AS	regDtm		/* 등록일시 */
        	,T1.REG_USER_NO		AS	regUserNo	/* 등록사용자번호 */
            ,T2.USER_EMAIL		AS	regUserId	/* 등록사용자ID */
        	,T1.UPD_DTM			AS	updDtm		/* 수정일시 */
        	,T1.UPD_USER_NO		AS	updUserNo	/* 수정사용자번호 */
        	,T1.BOARD_RFNC_CNT	AS	boardRfncCnt/* 조회수 */
        	,T1.DEL_YN			AS	delYn		/* 삭제여부 */
        FROM
         	CM_BOARD 	T1			/* 게시판T */
			INNER JOIN MB_USER T2	/* 사용자T */
            ON T1.REG_USER_NO = T2.USER_NO
        <where>
        	<if test='boardNo != null and boardNo != "" and boardNo > 0'>
        	AND T1.BOARD_NO = #{boardNo}	/* 게시글번호 */
        	</if>
        	AND T1.DEL_YN = 'N'		/* 삭제여부 N */
        </where>
    </select>
    
    <insert id="createContent" parameterType="Community" useGeneratedKeys="true" keyProperty="boardNo">
    	INSERT INTO CM_BOARD 
    	(
    		 BOARD_SE_CD		/* 게시판유형 */
    		,BOARD_TTL			/* 제목 */
    		,BOARD_CONT			/* 내용 */
    		,REG_DTM			/* 등록일시 */
    		,REG_USER_NO		/* 등록사용자번호 */
    		,UPD_DTM			/* 수정일시 */
    		,UPD_USER_NO		/* 수정사용자번호 */
    		,BOARD_RFNC_CNT		/* 조회수 */
    		,DEL_YN				/* 삭제여부 */
    	) 
    	VALUES 
 		(
 			 #{boardSeCd}
 			,#{boardTtl}
 			,#{boardCont}
 			,NOW()
 			,#{regUserNo}
 			,NOW()
 			,#{updUserNo}
 			,0
 			,'N'
    	)
    </insert>
    
    <update id="boardRfncCnt" parameterType="Community">
    UPDATE
    	CM_BOARD
    SET
    	BOARD_RFNC_CNT = BOARD_RFNC_CNT+1
    <where>
    	AND BOARD_NO = #{boardNo}
    </where>
    </update>
    
    <select id="getReplyList" parameterType="Community" resultType="CmReply">
        SELECT 
		T1.REPLY_NO		AS	replyNo
	    ,T1.UP_REPLY_NO	AS	upReplyNo
	    ,T2.USER_NICK_NM	AS	userNickNm
	    ,T1.BOARD_NO		AS	boardNo
	    ,T1.REPLY_CONT		AS	replyCont
	    ,T1.REG_DTM		AS	regDtm
	    ,FN_DATEDIFF_TO_STR(T1.REG_DTM) AS regDtmStr
	    ,T2.USER_EMAIL	AS	regUserEmail
	FROM 
		CM_REPLY	T1			/* 댓글T */
			JOIN MB_USER	T2	/* 사용자T */
			ON T1.REG_USER_NO = T2.USER_NO
	<where>
		AND BOARD_NO = #{boardNo}
	    AND DEL_YN = 'N'	/* 삭제여부 N */
	</where>
	GROUP BY REPLY_NO, UP_REPLY_NO
    ORDER BY 
        CASE WHEN UP_REPLY_NO IS NOT NULL THEN UP_REPLY_NO
			WHEN UP_REPLY_NO IS NULL THEN REPLY_NO
        END
    </select>
    
</mapper>